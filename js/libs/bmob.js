/*!
 * Bmob WeChat applet SDK
 * http://www.bmob.cn
 * Copyright Bmob, Inc.
 * The Bmob WeChat applet SDK is freely distributable under the MIT license.
 * (c) 2016-2050 Magic
 */
(function(n){var v=require("underscore.js");var q={};q.VERSION="js0.0.1";q._=v;var e=function(){};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=q}exports.Bmob=q}else{n.Bmob=q}var j=function(x,w,y){var z;if(w&&w.hasOwnProperty("constructor")){z=w.constructor}else{z=function(){x.apply(this,arguments)}}q._.extend(z,x);e.prototype=x.prototype;z.prototype=new e();if(w){q._.extend(z.prototype,w)}if(y){q._.extend(z,y)}z.prototype.constructor=z;z.__super__=x.prototype;return z};q.serverURL="https://api.bmob.cn";q.fileURL="http://file.bmob.cn";q.socketURL="https://api.bmob.cn";if(typeof(process)!=="undefined"&&process.versions&&process.versions.node){q._isNode=true}q.initialize=function(y,x,w){q._initialize(y,x,w)};q._initialize=function(y,x,w){q.applicationId=y;q.applicationKey=x;q.masterKey=w;q._useMasterKey=true;q.serverURL="https://"+y+".bmobcloud.com"};if(q._isNode){q.initialize=q._initialize}q._getBmobPath=function(w){if(!q.applicationId){throw"You need to call Bmob.initialize before using Bmob."}if(!w){w=""}if(!q._.isString(w)){throw"Tried to get a localStorage path that wasn't a String."}if(w[0]==="/"){w=w.substring(1)}return"Bmob/"+q.applicationId+"/"+w};q._getBmobPath=function(w){if(!q.applicationId){throw"You need to call Bmob.initialize before using Bmob."}if(!w){w=""}if(!q._.isString(w)){throw"Tried to get a localStorage path that wasn't a String."}if(w[0]==="/"){w=w.substring(1)}return"Bmob/"+q.applicationId+"/"+w};q._installationId=null;q._getInstallationId=function(){if(q._installationId){return q._installationId}var x=q._getBmobPath("installationId");wx.getStorage({key:"key",success:function(y){q._installationId=y.data;console.log(y.data)}});if(!q._installationId||q._installationId===""){var w=function(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)};q._installationId=(w()+w()+"-"+w()+"-"+w()+"-"+w()+"-"+w()+w()+w());wx.setStorage({key:x,data:q._installationId})}return q._installationId};q._parseDate=function(F){var C=new RegExp("^([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2})"+"T"+"([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})"+"(.([0-9]+))?"+"Z$");var A=C.exec(F);if(!A){return null}var D=A[1]||0;var B=(A[2]||1)-1;var E=A[3]||0;var y=A[4]||0;var x=A[5]||0;var w=A[6]||0;var z=A[8]||0;return new Date(Date.UTC(D,B,E,y,x,w,z))};q._ajax=function(D,y,A,C,x){var w={success:C,error:x};var B=new q.Promise();var z=JSON.parse(A);var x;wx.showNavigationBarLoading();if(z.category=="wechatApp"){wx.uploadFile({url:y,filePath:z.base64,name:"file",header:{"X-Bmob-SDK-Type":"wechatApp"},formData:z,success:function(E){console.log(E);var F=JSON.parse(E.data);B.resolve(F,E.statusCode,E);wx.hideNavigationBarLoading()},fail:function(E){console.log(E);B.reject(E);wx.hideNavigationBarLoading()}})}else{wx.request({method:D,url:y,data:A,header:{"content-type":"text/plain"},success:function(E){if(E.data&&E.data.code){B.reject(E)}else{if(E.statusCode!=200){B.reject(E)}else{B.resolve(E.data,E.statusCode,E)}}wx.hideNavigationBarLoading()},fail:function(E){B.reject(E);wx.hideNavigationBarLoading()}})}if(x){return q.Promise.error(x)}return B._thenRunCallbacks(w)};q._extend=function(w,x){var y=j(this,w,x);y.extend=this.extend;return y};q._request=function(y,B,x,D,A){if(!q.applicationId){throw"You must specify your applicationId using Bmob.initialize"}if(!q.applicationKey&&!q.masterKey){throw"You must specify a key using Bmob.initialize"}var z=q.serverURL;if(z.charAt(z.length-1)!=="/"){z+="/"}if(y.indexOf("2/")<0){z+="1/"+y}else{z+=y}if(B){z+="/"+B}if(x){z+="/"+x}if((y==="users"||y==="classes")&&D==="PUT"&&A._fetchWhenSave){delete A._fetchWhenSave;z+="?new=true"}A=q._.clone(A||{});if(D!=="POST"){A._Method=D;D="POST"}A._ApplicationId=q.applicationId;A._RestKey=q.applicationKey;if(q._useMasterKey&&q.masterKey!=undefined){A._MasterKey=q.masterKey}A._ClientVersion=q.VERSION;A._InstallationId=q._getInstallationId();var w=q.User.current();if(w&&w._sessionToken){A._SessionToken=w._sessionToken}var C=JSON.stringify(A);return q._ajax(D,z,C).then(null,function(E){var F;try{if(E.data.code){F=new q.Error(E.data.code,E.data.error)}}catch(G){}F=F||new q.Error(-1,E.data);return q.Promise.error(F)})};q._getValue=function(w,x){if(!(w&&w[x])){return null}return q._.isFunction(w[x])?w[x]():w[x]};q._encode=function(A,z,y){var x=q._;if(A instanceof q.Object){if(y){throw"Bmob.Objects not allowed here"}if(!z||x.include(z,A)||!A._hasData){return A._toPointer()}if(!A.dirty()){z=z.concat(A);return q._encode(A._toFullJSON(z),z,y)}throw"Tried to save an object with a pointer to a new, unsaved object."}if(A instanceof q.ACL){return A.toJSON()}if(x.isDate(A)){return{"__type":"Date","iso":A.toJSON()}}if(A instanceof q.GeoPoint){return A.toJSON()}if(x.isArray(A)){return x.map(A,function(B){return q._encode(B,z,y)})}if(x.isRegExp(A)){return A.source
}if(A instanceof q.Relation){return A.toJSON()}if(A instanceof q.Op){return A.toJSON()}if(A instanceof q.File){if(!A.url()){throw"Tried to save an object containing an unsaved file."}return{"__type":"File","cdn":A.cdn(),"filename":A.name(),"url":A.url()}}if(x.isObject(A)){var w={};q._objectEach(A,function(C,B){w[B]=q._encode(C,z,y)});return w}return A};q._decode=function(z,C){var x=q._;if(!x.isObject(C)){return C}if(x.isArray(C)){q._arrayEach(C,function(F,E){C[E]=q._decode(E,F)});return C}if(C instanceof q.Object){return C}if(C instanceof q.File){return C}if(C instanceof q.Op){return C}if(C.__op){return q.Op._decode(C)}if(C.__type==="Pointer"){var A=C.className;var D=q.Object._create(A);if(C.createdAt){delete C.__type;delete C.className;D._finishFetch(C,true)}else{D._finishFetch({objectId:C.objectId},false)}return D}if(C.__type==="Object"){var A=C.className;delete C.__type;delete C.className;var w=q.Object._create(A);w._finishFetch(C,true);return w}if(C.__type==="Date"){return C.iso}if(C.__type==="GeoPoint"){return new q.GeoPoint({latitude:C.latitude,longitude:C.longitude})}if(z==="ACL"){if(C instanceof q.ACL){return C}return new q.ACL(C)}if(C.__type==="Relation"){var B=new q.Relation(null,z);B.targetClassName=C.className;return B}if(C.__type==="File"){if(C.url!=undefined&&C.url!=null){if(C.url.indexOf("http")>=0){var y={"_name":C.filename,"_url":C.url,"url":C.url,"_group":C.group}}else{var y={"_name":C.filename,"_url":q.fileURL+"/"+C.url,"url":C.url,"_group":C.group}}}else{var y={"_name":C.filename,"_url":C.url,"url":C.url,"_group":C.group}}return y}q._objectEach(C,function(F,E){C[E]=q._decode(E,F)});return C};q._arrayEach=q._.each;q._traverse=function(x,y,w){if(x instanceof q.Object){w=w||[];if(q._.indexOf(w,x)>=0){return}w.push(x);q._traverse(x.attributes,y,w);return y(x)}if(x instanceof q.Relation||x instanceof q.File){return y(x)}if(q._.isArray(x)){q._.each(x,function(B,A){var z=q._traverse(B,y,w);if(z){x[A]=z}});return y(x)}if(q._.isObject(x)){q._each(x,function(B,A){var z=q._traverse(B,y,w);if(z){x[A]=z}});return y(x)}return y(x)};q._objectEach=q._each=function(x,y){var w=q._;if(w.isObject(x)){w.each(w.keys(x),function(z){y(x[z],z)})}else{w.each(x,y)}};q._isNullOrUndefined=function(w){return q._.isNull(w)||q._.isUndefined(w)};q.Error=function(x,w){this.code=x;this.message=w};v.extend(q.Error,{OTHER_CAUSE:-1,OBJECT_NOT_FOUND:101,INVALID_QUERY:102,INVALID_CLASS_NAME:103,RELATIONDOCNOTEXISTS:104,INVALID_KEY_NAME:105,INVALID_POINTER:106,INVALID_JSON:107,USERNAME_PASSWORD_REQUIRED:108,INCORRECT_TYPE:111,REQUEST_MUST_ARRAY:112,REQUEST_MUST_OBJECT:113,OBJECT_TOO_LARGE:114,GEO_ERROR:117,EMAIL_VERIFY_MUST_OPEN:120,CACHE_MISS:120,INVALID_DEVICE_TOKEN:131,INVALID_INSTALLID:132,INVALID_DEVICE_TYPE:133,DEVICE_TOKEN_EXIST:134,INSTALLID_EXIST:135,DEVICE_TOKEN_NOT_FOR_ANDROID:136,INVALID_INSTALL_OPERATE:137,READ_ONLY:138,INVALID_ROLE_NAME:139,MISS_PUSH_DATA:141,INVALID_PUSH_TIME:142,INVALID_PUSH_EXPIRE:143,PUSH_TIME_MUST_BEFORE_NOW:144,FILE_SIZE_ERROR:145,FILE_NAME_ERROR:146,FILE_NAME_ERROR:147,FILE_LEN_ERROR:148,FILE_UPLOAD_ERROR:150,FILE_DELETE_ERROR:151,IMAGE_ERROR:160,IMAGE_MODE_ERROR:161,IMAGE_WIDTH_ERROR:162,IMAGE_HEIGHT_ERROR:163,IMAGE_LONGEDGE_ERROR:164,IMAGE_SHORTEDGE_ERROR:165,USER_MISSING:201,USER_NAME_TOKEN:202,EMAIL_EXIST:203,NO_EMAIL:204,NOT_FOUND_EMAIL:205,SESSIONTOKEN_ERROR:206,VALID_ERROR:301});q.Events={on:function(z,D,y){var x,B,A,w,C;if(!D){return this}z=z.split(a);x=this._callbacks||(this._callbacks={});B=z.shift();while(B){C=x[B];A=C?C.tail:{};A.next=w={};A.context=y;A.callback=D;x[B]={tail:w,next:C?C.next:A};B=z.shift()}return this},off:function(D,B,x){var w,E,y,A,z,C;if(!(E=this._callbacks)){return}if(!(D||B||x)){delete this._callbacks;return this}D=D?D.split(a):v.keys(E);w=D.shift();while(w){y=E[w];delete E[w];if(!y||!(B||x)){continue}A=y.tail;y=y.next;while(y!==A){z=y.callback;C=y.context;if((B&&z!==B)||(x&&C!==x)){this.on(w,z,C)}y=y.next}w=D.shift()}return this},trigger:function(z){var D,C,y,x,w,B,A;if(!(y=this._callbacks)){return this}B=y.all;z=z.split(a);A=slice.call(arguments,1);D=z.shift();while(D){C=y[D];if(C){x=C.tail;while((C=C.next)!==x){C.callback.apply(C.context||this,A)}}C=B;if(C){x=C.tail;w=[D].concat(A);while((C=C.next)!==x){C.callback.apply(C.context||this,w)}}D=z.shift()}return this}};q.Events.bind=q.Events.on;q.Events.unbind=q.Events.off;q.GeoPoint=function(y,x){if(v.isArray(y)){q.GeoPoint._validate(y[0],y[1]);this.latitude=y[0];this.longitude=y[1]}else{if(v.isObject(y)){q.GeoPoint._validate(y.latitude,y.longitude);this.latitude=y.latitude;this.longitude=y.longitude}else{if(v.isNumber(y)&&v.isNumber(x)){q.GeoPoint._validate(y,x);this.latitude=y;this.longitude=x}else{this.latitude=0;this.longitude=0}}}var w=this;if(this.__defineGetter__&&this.__defineSetter__){this._latitude=this.latitude;this._longitude=this.longitude;this.__defineGetter__("latitude",function(){return w._latitude});this.__defineGetter__("longitude",function(){return w._longitude});this.__defineSetter__("latitude",function(z){q.GeoPoint._validate(z,w.longitude);
w._latitude=z});this.__defineSetter__("longitude",function(z){q.GeoPoint._validate(w.latitude,z);w._longitude=z})}};q.GeoPoint._validate=function(x,w){if(x<-90){throw"Bmob.GeoPoint latitude "+x+" < -90.0."}if(x>90){throw"Bmob.GeoPoint latitude "+x+" > 90.0."}if(w<-180){throw"Bmob.GeoPoint longitude "+w+" < -180.0."}if(w>180){throw"Bmob.GeoPoint longitude "+w+" > 180.0."}};q.GeoPoint.current=function(w){var x=new q.Promise();navigator.geolocation.getCurrentPosition(function(y){x.resolve(new q.GeoPoint({latitude:y.coords.latitude,longitude:y.coords.longitude}))},function(y){x.reject(y)});return x._thenRunCallbacks(w)};q.GeoPoint.prototype={toJSON:function(){q.GeoPoint._validate(this.latitude,this.longitude);return{"__type":"GeoPoint",latitude:this.latitude,longitude:this.longitude}},radiansTo:function(G){var A=Math.PI/180;var w=this.latitude*A;var C=this.longitude*A;var F=G.latitude*A;var z=G.longitude*A;var y=w-F;var B=C-z;var x=Math.sin(y/2);var D=Math.sin(B/2);var E=((x*x)+(Math.cos(w)*Math.cos(F)*D*D));E=Math.min(1,E);return 2*Math.asin(Math.sqrt(E))},kilometersTo:function(w){return this.radiansTo(w)*6371},milesTo:function(w){return this.radiansTo(w)*3958.8}};var k="*";q.ACL=function(x){var w=this;w.permissionsById={};if(v.isObject(x)){if(x instanceof q.User){w.setReadAccess(x,true);w.setWriteAccess(x,true)}else{if(v.isFunction(x)){throw"Bmob.ACL() called with a function.  Did you forget ()?"}q._objectEach(x,function(z,y){if(!v.isString(y)){throw"Tried to create an ACL with an invalid userId."}w.permissionsById[y]={};q._objectEach(z,function(B,A){if(A!=="read"&&A!=="write"){throw"Tried to create an ACL with an invalid permission type."}if(!v.isBoolean(B)){throw"Tried to create an ACL with an invalid permission value."}w.permissionsById[y][A]=B})})}}};q.ACL.prototype.toJSON=function(){return v.clone(this.permissionsById)};q.ACL.prototype._setAccess=function(w,x,z){if(x instanceof q.User){x=x.id}else{if(x instanceof q.Role){x="role:"+x.getName()}}if(!v.isString(x)){throw"userId must be a string."}if(!v.isBoolean(z)){throw"allowed must be either true or false."}var y=this.permissionsById[x];if(!y){if(!z){return}else{y={};this.permissionsById[x]=y}}if(z){this.permissionsById[x][w]=true}else{delete y[w];if(v.isEmpty(y)){delete y[x]}}};q.ACL.prototype._getAccess=function(w,x){if(x instanceof q.User){x=x.id}else{if(x instanceof q.Role){x="role:"+x.getName()}}var y=this.permissionsById[x];if(!y){return false}return y[w]?true:false};q.ACL.prototype.setReadAccess=function(w,x){this._setAccess("read",w,x)};q.ACL.prototype.getReadAccess=function(w){return this._getAccess("read",w)};q.ACL.prototype.setWriteAccess=function(w,x){this._setAccess("write",w,x)};q.ACL.prototype.getWriteAccess=function(w){return this._getAccess("write",w)};q.ACL.prototype.setPublicReadAccess=function(w){this.setReadAccess(k,w)};q.ACL.prototype.getPublicReadAccess=function(){return this.getReadAccess(k)};q.ACL.prototype.setPublicWriteAccess=function(w){this.setWriteAccess(k,w)};q.ACL.prototype.getPublicWriteAccess=function(){return this.getWriteAccess(k)};q.ACL.prototype.getRoleReadAccess=function(w){if(w instanceof q.Role){w=w.getName()}if(v.isString(w)){return this.getReadAccess("role:"+w)}throw"role must be a Bmob.Role or a String"};q.ACL.prototype.getRoleWriteAccess=function(w){if(w instanceof q.Role){w=w.getName()}if(v.isString(w)){return this.getWriteAccess("role:"+w)}throw"role must be a Bmob.Role or a String"};q.ACL.prototype.setRoleReadAccess=function(x,w){if(x instanceof q.Role){x=x.getName()}if(v.isString(x)){this.setReadAccess("role:"+x,w);return}throw"role must be a Bmob.Role or a String"};q.ACL.prototype.setRoleWriteAccess=function(x,w){if(x instanceof q.Role){x=x.getName()}if(v.isString(x)){this.setWriteAccess("role:"+x,w);return}throw"role must be a Bmob.Role or a String"};q.Op=function(){this._initialize.apply(this,arguments)};q.Op.prototype={_initialize:function(){}};v.extend(q.Op,{_extend:q._extend,_opDecoderMap:{},_registerDecoder:function(w,x){q.Op._opDecoderMap[w]=x},_decode:function(w){var x=q.Op._opDecoderMap[w.__op];if(x){return x(w)}else{return undefined}}});q.Op._registerDecoder("Batch",function(w){var x=null;q._arrayEach(w.ops,function(y){y=q.Op._decode(y);x=y._mergeWithPrevious(x)});return x});q.Op.Set=q.Op._extend({_initialize:function(w){this._value=w},value:function(){return this._value},toJSON:function(){return q._encode(this.value())},_mergeWithPrevious:function(w){return this},_estimate:function(w){return this.value()}});q.Op._UNSET={};q.Op.Unset=q.Op._extend({toJSON:function(){return{__op:"Delete"}},_mergeWithPrevious:function(w){return this},_estimate:function(w){return q.Op._UNSET}});q.Op._registerDecoder("Delete",function(w){return new q.Op.Unset()});q.Op.Increment=q.Op._extend({_initialize:function(w){this._amount=w},amount:function(){return this._amount},toJSON:function(){return{__op:"Increment",amount:this._amount}},_mergeWithPrevious:function(w){if(!w){return this}else{if(w instanceof q.Op.Unset){return new q.Op.Set(this.amount())
}else{if(w instanceof q.Op.Set){return new q.Op.Set(w.value()+this.amount())}else{if(w instanceof q.Op.Increment){return new q.Op.Increment(this.amount()+w.amount())}else{throw"Op is invalid after previous op."}}}}},_estimate:function(w){if(!w){return this.amount()}return w+this.amount()}});q.Op._registerDecoder("Increment",function(w){return new q.Op.Increment(w.amount)});q.Op.Add=q.Op._extend({_initialize:function(w){this._objects=w},objects:function(){return this._objects},toJSON:function(){return{__op:"Add",objects:q._encode(this.objects())}},_mergeWithPrevious:function(w){if(!w){return this}else{if(w instanceof q.Op.Unset){return new q.Op.Set(this.objects())}else{if(w instanceof q.Op.Set){return new q.Op.Set(this._estimate(w.value()))}else{if(w instanceof q.Op.Add){return new q.Op.Add(w.objects().concat(this.objects()))}else{throw"Op is invalid after previous op."}}}}},_estimate:function(w){if(!w){return v.clone(this.objects())}else{return w.concat(this.objects())}}});q.Op._registerDecoder("Add",function(w){return new q.Op.Add(q._decode(undefined,w.objects))});q.Op.AddUnique=q.Op._extend({_initialize:function(w){this._objects=v.uniq(w)},objects:function(){return this._objects},toJSON:function(){return{__op:"AddUnique",objects:q._encode(this.objects())}},_mergeWithPrevious:function(w){if(!w){return this}else{if(w instanceof q.Op.Unset){return new q.Op.Set(this.objects())}else{if(w instanceof q.Op.Set){return new q.Op.Set(this._estimate(w.value()))}else{if(w instanceof q.Op.AddUnique){return new q.Op.AddUnique(this._estimate(w.objects()))}else{throw"Op is invalid after previous op."}}}}},_estimate:function(w){if(!w){return v.clone(this.objects())}else{var x=v.clone(w);q._arrayEach(this.objects(),function(A){if(A instanceof q.Object&&A.id){var z=v.find(x,function(B){return(B instanceof q.Object)&&(B.id===A.id)});if(!z){x.push(A)}else{var y=v.indexOf(x,z);x[y]=A}}else{if(!v.contains(x,A)){x.push(A)}}});return x}}});q.Op._registerDecoder("AddUnique",function(w){return new q.Op.AddUnique(q._decode(undefined,w.objects))});q.Op.Remove=q.Op._extend({_initialize:function(w){this._objects=v.uniq(w)},objects:function(){return this._objects},toJSON:function(){return{__op:"Remove",objects:q._encode(this.objects())}},_mergeWithPrevious:function(w){if(!w){return this}else{if(w instanceof q.Op.Unset){return w}else{if(w instanceof q.Op.Set){return new q.Op.Set(this._estimate(w.value()))}else{if(w instanceof q.Op.Remove){return new q.Op.Remove(v.union(w.objects(),this.objects()))}else{throw"Op is invalid after previous op."}}}}},_estimate:function(w){if(!w){return[]}else{var x=v.difference(w,this.objects());q._arrayEach(this.objects(),function(y){if(y instanceof q.Object&&y.id){x=v.reject(x,function(z){return(z instanceof q.Object)&&(z.id===y.id)})}});return x}}});q.Op._registerDecoder("Remove",function(w){return new q.Op.Remove(q._decode(undefined,w.objects))});q.Op.Relation=q.Op._extend({_initialize:function(z,x){this._targetClassName=null;var w=this;var y=function(A){if(A instanceof q.Object){if(!A.id){throw"You can't add an unsaved Bmob.Object to a relation."}if(!w._targetClassName){w._targetClassName=A.className}if(w._targetClassName!==A.className){throw"Tried to create a Bmob.Relation with 2 different types: "+w._targetClassName+" and "+A.className+"."}return A.id}return A};this.relationsToAdd=v.uniq(v.map(z,y));this.relationsToRemove=v.uniq(v.map(x,y))},added:function(){var w=this;return v.map(this.relationsToAdd,function(x){var y=q.Object._create(w._targetClassName);y.id=x;return y})},removed:function(){var w=this;return v.map(this.relationsToRemove,function(x){var y=q.Object._create(w._targetClassName);y.id=x;return y})},toJSON:function(){var A=null;var y=null;var x=this;var z=function(B){return{__type:"Pointer",className:x._targetClassName,objectId:B}};var w=null;if(this.relationsToAdd.length>0){w=v.map(this.relationsToAdd,z);A={"__op":"AddRelation","objects":w}}if(this.relationsToRemove.length>0){w=v.map(this.relationsToRemove,z);y={"__op":"RemoveRelation","objects":w}}if(A&&y){return{"__op":"Batch","ops":[A,y]}}return A||y||{}},_mergeWithPrevious:function(z){if(!z){return this}else{if(z instanceof q.Op.Unset){throw"You can't modify a relation after deleting it."}else{if(z instanceof q.Op.Relation){if(z._targetClassName&&z._targetClassName!==this._targetClassName){throw"Related object must be of class "+z._targetClassName+", but "+this._targetClassName+" was passed in."}var y=v.union(v.difference(z.relationsToAdd,this.relationsToRemove),this.relationsToAdd);var x=v.union(v.difference(z.relationsToRemove,this.relationsToAdd),this.relationsToRemove);var w=new q.Op.Relation(y,x);w._targetClassName=this._targetClassName;return w}else{throw"Op is invalid after previous op."}}}},_estimate:function(x,w,y){if(!x){var z=new q.Relation(w,y);z.targetClassName=this._targetClassName}else{if(x instanceof q.Relation){if(this._targetClassName){if(x.targetClassName){if(x.targetClassName!==this._targetClassName){throw"Related object must be a "+x.targetClassName+", but a "+this._targetClassName+" was passed in."
}}else{x.targetClassName=this._targetClassName}}return x}else{throw"Op is invalid after previous op."}}}});q.Op._registerDecoder("AddRelation",function(w){return new q.Op.Relation(q._decode(undefined,w.objects),[])});q.Op._registerDecoder("RemoveRelation",function(w){return new q.Op.Relation([],q._decode(undefined,w.objects))});q.Relation=function(x,w){this.parent=x;this.key=w;this.targetClassName=null};q.Relation.reverseQuery=function(x,z,y){var w=new q.Query(x);w.equalTo(z,y._toPointer());return w};q.Relation.prototype={_ensureParentAndKey:function(x,w){this.parent=this.parent||x;this.key=this.key||w;if(this.parent!==x){throw"Internal Error. Relation retrieved from two different Objects."}if(this.key!==w){throw"Internal Error. Relation retrieved from two different keys."}},add:function(w){if(!v.isArray(w)){w=[w]}var x=new q.Op.Relation(w,[]);this.parent.set(this.key,x);this.targetClassName=x._targetClassName},remove:function(w){if(!v.isArray(w)){w=[w]}var x=new q.Op.Relation([],w);this.parent.set(this.key,x);this.targetClassName=x._targetClassName},toJSON:function(){return{"__type":"Relation","className":this.targetClassName}},query:function(){var w;var x;if(!this.targetClassName){w=q.Object._getSubclass(this.parent.className);x=new q.Query(w);x._extraOptions.redirectClassNameForKey=this.key}else{w=q.Object._getSubclass(this.targetClassName);x=new q.Query(w)}x._addCondition("$relatedTo","object",this.parent._toPointer());x._addCondition("$relatedTo","key",this.key);return x}};q.Promise=function(){this._resolved=false;this._rejected=false;this._resolvedCallbacks=[];this._rejectedCallbacks=[]};v.extend(q.Promise,{is:function(w){return w&&w.then&&v.isFunction(w.then)},as:function(){var w=new q.Promise();w.resolve.apply(w,arguments);return w},error:function(){var w=new q.Promise();w.reject.apply(w,arguments);return w},when:function(z){var B;if(z&&q._isNullOrUndefined(z.length)){B=arguments}else{B=z}var A=B.length;var x=false;var y=[];var D=[];y.length=B.length;D.length=B.length;if(A===0){return q.Promise.as.apply(this,y)}var C=new q.Promise();var w=function(){A=A-1;if(A===0){if(x){C.reject(D)}else{C.resolve.apply(C,y)}}};q._arrayEach(B,function(E,F){if(q.Promise.is(E)){E.then(function(G){y[F]=G;w()},function(G){D[F]=G;x=true;w()})}else{y[F]=E;w()}});return C},_continueWhile:function(w,x){if(w()){return x().then(function(){return q.Promise._continueWhile(w,x)})}return q.Promise.as()}});v.extend(q.Promise.prototype,{resolve:function(w){if(this._resolved||this._rejected){throw"A promise was resolved even though it had already been "+(this._resolved?"resolved":"rejected")+"."}this._resolved=true;this._result=arguments;var x=arguments;q._arrayEach(this._resolvedCallbacks,function(y){y.apply(this,x)});this._resolvedCallbacks=[];this._rejectedCallbacks=[]},reject:function(w){if(this._resolved||this._rejected){throw"A promise was rejected even though it had already been "+(this._resolved?"resolved":"rejected")+"."}this._rejected=true;this._error=w;q._arrayEach(this._rejectedCallbacks,function(x){x(w)});this._resolvedCallbacks=[];this._rejectedCallbacks=[]},then:function(w,y){var z=new q.Promise();var A=function(){var B=arguments;if(w){B=[w.apply(this,B)]}if(B.length===1&&q.Promise.is(B[0])){B[0].then(function(){z.resolve.apply(z,arguments)},function(C){z.reject(C)})}else{z.resolve.apply(z,B)}};var x=function(C){var B=[];if(y){B=[y(C)];if(B.length===1&&q.Promise.is(B[0])){B[0].then(function(){z.resolve.apply(z,arguments)},function(D){z.reject(D)})}else{z.reject(B[0])}}else{z.reject(C)}};if(this._resolved){A.apply(this,this._result)}else{if(this._rejected){x(this._error)}else{this._resolvedCallbacks.push(A);this._rejectedCallbacks.push(x)}}return z},_thenRunCallbacks:function(y,x){var w;if(v.isFunction(y)){var z=y;w={success:function(A){z(A,null)},error:function(A){z(null,A)}}}else{w=v.clone(y)}w=w||{};return this.then(function(A){if(w.success){w.success.apply(this,arguments)}else{if(x){x.trigger("sync",x,A,w)}}return q.Promise.as.apply(q.Promise,arguments)},function(A){if(w.error){if(!v.isUndefined(x)){w.error(x,A)}else{w.error(A)}}else{if(x){x.trigger("error",x,A,w)}}return q.Promise.error(A)})},_continueWith:function(w){return this.then(function(){return w(arguments,null)},function(x){return w(null,x)})}});var u=function(w){if(w<26){return String.fromCharCode(65+w)}if(w<52){return String.fromCharCode(97+(w-26))}if(w<62){return String.fromCharCode(48+(w-52))}if(w===62){return"+"}if(w===63){return"/"}throw"Tried to encode large digit "+w+" in base64."};var p=function(D){var x="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var z,B,w;var C,A,y;w=D.length;B=0;z="";while(B<w){C=D.charCodeAt(B++)&255;if(B==w){z+=x.charAt(C>>2);z+=x.charAt((C&3)<<4);z+="==";break}A=D.charCodeAt(B++);if(B==w){z+=x.charAt(C>>2);z+=x.charAt(((C&3)<<4)|((A&240)>>4));z+=x.charAt((A&15)<<2);z+="=";break}y=D.charCodeAt(B++);z+=x.charAt(C>>2);z+=x.charAt(((C&3)<<4)|((A&240)>>4));z+=x.charAt(((A&15)<<2)|((y&192)>>6));z+=x.charAt(y&63)
}return z};var i=function(z){var x,y,w,A;x="";w=z.length;for(y=0;y<w;y++){A=z.charCodeAt(y);if((A>=1)&&(A<=127)){x+=z.charAt(y)}else{if(A>2047){x+=String.fromCharCode(224|((A>>12)&15));x+=String.fromCharCode(128|((A>>6)&63));x+=String.fromCharCode(128|((A>>0)&63))}else{x+=String.fromCharCode(192|((A>>6)&31));x+=String.fromCharCode(128|((A>>0)&63))}}}return x};var t={ai:"application/postscript",aif:"audio/x-aiff",aifc:"audio/x-aiff",aiff:"audio/x-aiff",asc:"text/plain",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bcpio:"application/x-bcpio",bin:"application/octet-stream",bmp:"image/bmp",cdf:"application/x-netcdf",cgm:"image/cgm","class":"application/octet-stream",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",dcr:"application/x-director",dif:"video/x-dv",dir:"application/x-director",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/octet-stream",dmg:"application/octet-stream",dms:"application/octet-stream",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml."+"document",dotx:"application/vnd.openxmlformats-officedocument.wordprocessingml."+"template",docm:"application/vnd.ms-word.document.macroEnabled.12",dotm:"application/vnd.ms-word.template.macroEnabled.12",dtd:"application/xml-dtd",dv:"video/x-dv",dvi:"application/x-dvi",dxr:"application/x-director",eps:"application/postscript",etx:"text/x-setext",exe:"application/octet-stream",ez:"application/andrew-inset",gif:"image/gif",gram:"application/srgs",grxml:"application/srgs+xml",gtar:"application/x-gtar",hdf:"application/x-hdf",hqx:"application/mac-binhex40",htm:"text/html",html:"text/html",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ics:"text/calendar",ief:"image/ief",ifb:"text/calendar",iges:"model/iges",igs:"model/iges",jnlp:"application/x-java-jnlp-file",jp2:"image/jp2",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/x-javascript",kar:"audio/midi",latex:"application/x-latex",lha:"application/octet-stream",lzh:"application/octet-stream",m3u:"audio/x-mpegurl",m4a:"audio/mp4a-latm",m4b:"audio/mp4a-latm",m4p:"audio/mp4a-latm",m4u:"video/vnd.mpegurl",m4v:"video/x-m4v",mac:"image/x-macpaint",man:"application/x-troff-man",mathml:"application/mathml+xml",me:"application/x-troff-me",mesh:"model/mesh",mid:"audio/midi",midi:"audio/midi",mif:"application/vnd.mif",mov:"video/quicktime",movie:"video/x-sgi-movie",mp2:"audio/mpeg",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",msh:"model/mesh",mxu:"video/vnd.mpegurl",nc:"application/x-netcdf",oda:"application/oda",ogg:"application/ogg",pbm:"image/x-portable-bitmap",pct:"image/pict",pdb:"chemical/x-pdb",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pic:"image/pict",pict:"image/pict",png:"image/png",pnm:"image/x-portable-anymap",pnt:"image/x-macpaint",pntg:"image/x-macpaint",ppm:"image/x-portable-pixmap",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml."+"presentation",potx:"application/vnd.openxmlformats-officedocument.presentationml."+"template",ppsx:"application/vnd.openxmlformats-officedocument.presentationml."+"slideshow",ppam:"application/vnd.ms-powerpoint.addin.macroEnabled.12",pptm:"application/vnd.ms-powerpoint.presentation.macroEnabled.12",potm:"application/vnd.ms-powerpoint.template.macroEnabled.12",ppsm:"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",ps:"application/postscript",qt:"video/quicktime",qti:"image/x-quicktime",qtif:"image/x-quicktime",ra:"audio/x-pn-realaudio",ram:"audio/x-pn-realaudio",ras:"image/x-cmu-raster",rdf:"application/rdf+xml",rgb:"image/x-rgb",rm:"application/vnd.rn-realmedia",roff:"application/x-troff",rtf:"text/rtf",rtx:"text/richtext",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skd:"application/x-koan",skm:"application/x-koan",skp:"application/x-koan",skt:"application/x-koan",smi:"application/smil",smil:"application/smil",snd:"audio/basic",so:"application/octet-stream",spl:"application/x-futuresplash",src:"application/x-wais-source",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",t:"application/x-troff",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",tif:"image/tiff",tiff:"image/tiff",tr:"application/x-troff",tsv:"text/tab-separated-values",txt:"text/plain",ustar:"application/x-ustar",vcd:"application/x-cdlink",vrml:"model/vrml",vxml:"application/voicexml+xml",wav:"audio/x-wav",wbmp:"image/vnd.wap.wbmp",wbmxl:"application/vnd.wap.wbxml",wml:"text/vnd.wap.wml",wmlc:"application/vnd.wap.wmlc",wmls:"text/vnd.wap.wmlscript",wmlsc:"application/vnd.wap.wmlscriptc",wrl:"model/vrml",xbm:"image/x-xbitmap",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xltx:"application/vnd.openxmlformats-officedocument.spreadsheetml."+"template",xlsm:"application/vnd.ms-excel.sheet.macroEnabled.12",xltm:"application/vnd.ms-excel.template.macroEnabled.12",xlam:"application/vnd.ms-excel.addin.macroEnabled.12",xlsb:"application/vnd.ms-excel.sheet.binary.macroEnabled.12",xslt:"application/xslt+xml",xul:"application/vnd.mozilla.xul+xml",xwd:"image/x-xwindowdump",xyz:"chemical/x-xyz",zip:"application/zip"};
var d=function(x,y){var z=new q.Promise();if(typeof(FileReader)==="undefined"){return q.Promise.error(new q.Error(-1,"Attempted to use a FileReader on an unsupported browser."))}var w=new FileReader();w.onloadend=function(){z.resolve(w.result)};w.readAsBinaryString(x);return z};q.File=function(x,z,y){var B=/\.([^.]*)$/.exec(x);if(B=="mp4"){z=z}else{z=z[0]}this._name=x;var w=q.User.current();this._metaData={owner:(w!=null?w.id:"unknown")};if(B){B=B[1].toLowerCase()}console.log(B);var A=y||t[B]||"text/plain";this._guessedType=A;if(typeof(File)!=="undefined"&&z instanceof File){this._source=d(z,y)}else{this._source=q.Promise.as(z,A);this._metaData.size=z.length}};q.File.prototype={name:function(){return this._name},setName:function(w){this._name=w},url:function(){return this._url},setUrl:function(w){this._url=w},cdn:function(){return this._cdn},metaData:function(w,x){if(w!=null&&x!=null){this._metaData[w]=x;return this}else{if(w!=null){return this._metaData[w]}else{return this._metaData}}},destroy:function(w){if(!this._url&&!this._cdn){return q.Promise.error("The file url and cdn is not eixsts.")._thenRunCallbacks(w)}var y={cdn:this._cdn,_ContentType:"application/json",url:this._url,metaData:self._metaData,};var x=q._request("2/files",null,null,"DELETE",y);return x._thenRunCallbacks(w)},save:function(x){var w=this;if(!w._previousSave){if(w._source){w._previousSave=w._source.then(function(y,z){var A={base64:y,_ContentType:"text/plain",mime_type:"text/plain",metaData:w._metaData,category:"wechatApp",};if(!w._metaData.size){w._metaData.size=y.length}return q._request("2/files",w._name,null,"POST",A)}).then(function(y){w._name=y.filename;w._url=y.url;w._cdn=y.cdn;return w})}else{throw"not source file"}}return w._previousSave._thenRunCallbacks(x)}};q.Files=q.Files||{};q.Files.del=function(A,w){var x=A.split(".com");if(!x){return q.Promise.error("The file url and cdn is not eixsts.")._thenRunCallbacks(w)}var z={_ContentType:"application/json",};var y=q._request("2/files/upyun",x[1],null,"DELETE",z);return y.then(function(B){return q._decode(null,B)})._thenRunCallbacks(w)};q.Object=function(w,x){if(v.isString(w)){return q.Object._create.apply(this,arguments)}w=w||{};if(x&&x.parse){w=this.parse(w)}var y=q._getValue(this,"defaults");if(y){w=v.extend({},y,w)}if(x&&x.collection){this.collection=x.collection}this._serverData={};this._opSetQueue=[{}];this.attributes={};this._hashedJSON={};this._escapedAttributes={};this.cid=v.uniqueId("c");this.changed={};this._silent={};this._pending={};if(!this.set(w,{silent:true})){throw new Error("Can't create an invalid Bmob.Object")}this.changed={};this._silent={};this._pending={};this._hasData=true;this._previousAttributes=v.clone(this.attributes);this.initialize.apply(this,arguments)};q.Object.saveAll=function(x,w){return q.Object._deepSaveAsync(x)._thenRunCallbacks(w)};v.extend(q.Object.prototype,q.Events,{_existed:false,_fetchWhenSave:false,initialize:function(){},fetchWhenSave:function(w){if(typeof w!=="boolean"){throw"Expect boolean value for fetchWhenSave"}this._fetchWhenSave=w},toJSON:function(){var w=this._toFullJSON();q._arrayEach(["__type","className"],function(x){delete w[x]});return w},_toFullJSON:function(x){var w=v.clone(this.attributes);q._objectEach(w,function(z,y){w[y]=q._encode(z,x)});q._objectEach(this._operations,function(z,y){w[y]=z});if(v.has(this,"id")){w.objectId=this.id}if(v.has(this,"createdAt")){if(v.isDate(this.createdAt)){w.createdAt=this.createdAt.toJSON()}else{w.createdAt=this.createdAt}}if(v.has(this,"updatedAt")){if(v.isDate(this.updatedAt)){w.updatedAt=this.updatedAt.toJSON()}else{w.updatedAt=this.updatedAt}}w.__type="Object";w.className=this.className;return w},_refreshCache:function(){var w=this;if(w._refreshingCache){return}w._refreshingCache=true;q._objectEach(this.attributes,function(y,x){if(y instanceof q.Object){y._refreshCache()}else{if(v.isObject(y)){if(w._resetCacheForKey(x)){w.set(x,new q.Op.Set(y),{silent:true})}}}});delete w._refreshingCache},dirty:function(w){this._refreshCache();var x=v.last(this._opSetQueue);if(w){return(x[w]?true:false)}if(!this.id){return true}if(v.keys(x).length>0){return true}return false},_toPointer:function(){return{__type:"Pointer",className:this.className,objectId:this.id}},get:function(w){return this.attributes[w]},relation:function(w){var x=this.get(w);if(x){if(!(x instanceof q.Relation)){throw"Called relation() on non-relation field "+w}x._ensureParentAndKey(this,w);return x}else{return new q.Relation(this,w)}},escape:function(w){var x=this._escapedAttributes[w];if(x){return x}var z=this.attributes[w];var y;if(q._isNullOrUndefined(z)){y=""}else{y=v.escape(z.toString())}this._escapedAttributes[w]=y;return y},has:function(w){return !q._isNullOrUndefined(this.attributes[w])},_mergeMagicFields:function(x){var w=this;var y=["id","objectId","createdAt","updatedAt"];q._arrayEach(y,function(z){if(x[z]){if(z==="objectId"){w.id=x[z]}else{w[z]=x[z]}delete x[z]}})},_startSave:function(){this._opSetQueue.push({})},_cancelSave:function(){var x=this;
var w=v.first(this._opSetQueue);this._opSetQueue=v.rest(this._opSetQueue);var y=v.first(this._opSetQueue);q._objectEach(w,function(C,A){var B=w[A];var z=y[A];if(B&&z){y[A]=z._mergeWithPrevious(B)}else{if(B){y[A]=B}}});this._saving=this._saving-1},_finishSave:function(y){var w={};q._traverse(this.attributes,function(A){if(A instanceof q.Object&&A.id&&A._hasData){w[A.id]=A}});var z=v.first(this._opSetQueue);this._opSetQueue=v.rest(this._opSetQueue);this._applyOpSet(z,this._serverData);this._mergeMagicFields(y);var x=this;q._objectEach(y,function(B,A){x._serverData[A]=q._decode(A,B);var C=q._traverse(x._serverData[A],function(D){if(D instanceof q.Object&&w[D.id]){return w[D.id]}});if(C){x._serverData[A]=C}});this._rebuildAllEstimatedData();this._saving=this._saving-1},_finishFetch:function(y,x){this._opSetQueue=[{}];this._mergeMagicFields(y);var w=this;q._objectEach(y,function(A,z){if(A.__type!="Object"){w._serverData[z]=q._decode(z,A)}else{w._serverData[z]=A}});this._rebuildAllEstimatedData();this._refreshCache();this._opSetQueue=[{}];this._hasData=x},_applyOpSet:function(x,y){var w=this;q._objectEach(x,function(A,z){y[z]=A._estimate(y[z],w,z);if(y[z]===q.Op._UNSET){delete y[z]}})},_resetCacheForKey:function(x){var y=this.attributes[x];if(v.isObject(y)&&!(y instanceof q.Object)&&!(y instanceof q.File)){y=y.toJSON?y.toJSON():y;var w=JSON.stringify(y);if(this._hashedJSON[x]!==w){this._hashedJSON[x]=w;return true}}return false},_rebuildEstimatedDataForKey:function(x){var w=this;delete this.attributes[x];if(this._serverData[x]){this.attributes[x]=this._serverData[x]}q._arrayEach(this._opSetQueue,function(y){var z=y[x];if(z){w.attributes[x]=z._estimate(w.attributes[x],w,x);if(w.attributes[x]===q.Op._UNSET){delete w.attributes[x]}else{w._resetCacheForKey(x)}}})},_rebuildAllEstimatedData:function(){var w=this;var x=v.clone(this.attributes);this.attributes=v.clone(this._serverData);q._arrayEach(this._opSetQueue,function(y){w._applyOpSet(y,w.attributes);q._objectEach(y,function(A,z){w._resetCacheForKey(z)})});q._objectEach(x,function(y,z){if(w.attributes[z]!==y){w.trigger("change:"+z,w,w.attributes[z],{})}});q._objectEach(this.attributes,function(z,y){if(!v.has(x,y)){w.trigger("change:"+y,w,z,{})}})},set:function(B,A,E){var C,z;if(v.isObject(B)||q._isNullOrUndefined(B)){C=B;q._objectEach(C,function(G,F){C[F]=q._decode(F,G)});E=A}else{C={};C[B]=q._decode(B,A)}E=E||{};if(!C){return this}if(C instanceof q.Object){C=C.attributes}if(E.unset){q._objectEach(C,function(F,G){C[G]=new q.Op.Unset()})}var y=v.clone(C);var D=this;q._objectEach(y,function(G,F){if(G instanceof q.Op){y[F]=G._estimate(D.attributes[F],D,F);if(y[F]===q.Op._UNSET){delete y[F]}}});if(!this._validate(C,E)){return false}this._mergeMagicFields(C);E.changes={};var w=this._escapedAttributes;var x=this._previousAttributes||{};q._arrayEach(v.keys(C),function(G){var I=C[G];if(I instanceof q.Relation){I.parent=D}if(!(I instanceof q.Op)){I=new q.Op.Set(I)}var F=true;if(I instanceof q.Op.Set&&v.isEqual(D.attributes[G],I.value)){F=false}if(F){delete w[G];if(E.silent){D._silent[G]=true}else{E.changes[G]=true}}var H=v.last(D._opSetQueue);H[G]=I._mergeWithPrevious(H[G]);D._rebuildEstimatedDataForKey(G);if(F){D.changed[G]=D.attributes[G];if(!E.silent){D._pending[G]=true}}else{delete D.changed[G];delete D._pending[G]}});if(!E.silent){this.change(E)}return this},unset:function(w,x){x=x||{};x.unset=true;return this.set(w,null,x)},increment:function(w,x){if(v.isUndefined(x)||v.isNull(x)){x=1}return this.set(w,new q.Op.Increment(x))},add:function(w,x){return this.set(w,new q.Op.Add([x]))},addUnique:function(w,x){return this.set(w,new q.Op.AddUnique([x]))},remove:function(w,x){return this.set(w,new q.Op.Remove([x]))},op:function(w){return v.last(this._opSetQueue)[w]},clear:function(w){w=w||{};w.unset=true;var x=v.extend(this.attributes,this._operations);return this.set(x,w)},_getSaveJSON:function(){var w=v.clone(v.first(this._opSetQueue));q._objectEach(w,function(y,x){w[x]=y.toJSON()});return w},_canBeSerialized:function(){return q.Object._canBeSerializedAsValue(this.attributes)},fetch:function(x){var w=this;var y=q._request("classes",this.className,this.id,"GET");return y.then(function(A,z,B){w._finishFetch(w.parse(A,z,B),true);return w})._thenRunCallbacks(x,this)},save:function(C,B,z){var y,H,D,K,G;if(v.isObject(C)||q._isNullOrUndefined(C)){H=C;K=B}else{H={};H[C]=B;K=z}if(!K&&H){var I=v.reject(H,function(M,L){return v.include(["success","error","wait"],L)});if(I.length===0){var J=true;if(v.has(H,"success")&&!v.isFunction(H.success)){J=false}if(v.has(H,"error")&&!v.isFunction(H.error)){J=false}if(J){return this.save(null,H)}}}K=v.clone(K)||{};if(K.wait){D=v.clone(this.attributes)}var E=v.clone(K)||{};if(E.wait){E.silent=true}var x;E.error=function(M,L){x=L};if(H&&!this.set(H,E)){return q.Promise.error(x)._thenRunCallbacks(K,this)}var A=this;A._refreshCache();var F=[];var w=[];q.Object._findUnsavedChildren(A.attributes,F,w);if(F.length+w.length>0){return q.Object._deepSaveAsync(this.attributes).then(function(){return A.save(null,K)
},function(L){return q.Promise.error(L)._thenRunCallbacks(K,A)})}this._startSave();this._saving=(this._saving||0)+1;this._allPreviousSaves=this._allPreviousSaves||q.Promise.as();this._allPreviousSaves=this._allPreviousSaves._continueWith(function(){var P=A.id?"PUT":"POST";var M=A._getSaveJSON();if(P==="PUT"&&A._fetchWhenSave){M._fetchWhenSave=true}var L="classes";var N=A.className;if(A.className==="_User"&&!A.id){L="users";N=null}var O=q._request(L,N,A.id,P,M);O=O.then(function(T,Q,S){var R=A.parse(T,Q,S);if(K.wait){R=v.extend(H||{},R)}A._finishSave(R);if(K.wait){A.set(D,E)}return A},function(Q){A._cancelSave();return q.Promise.error(Q)})._thenRunCallbacks(K,A);return O});return this._allPreviousSaves},destroy:function(x){x=x||{};var w=this;var z=function(){w.trigger("destroy",w,w.collection,x)};if(!this.id){return z()}if(!x.wait){z()}var y=q._request("classes",this.className,this.id,"DELETE");return y.then(function(){if(x.wait){z()}return w})._thenRunCallbacks(x,this)},parse:function(z,w,y){var x=v.clone(z);v(["createdAt","updatedAt"]).each(function(A){if(x[A]){x[A]=x[A]}});if(!x.updatedAt){x.updatedAt=x.createdAt}if(w){this._existed=(w!==201)}return x},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return !this.id},change:function(y){y=y||{};var A=this._changing;this._changing=true;var x=this;q._objectEach(this._silent,function(B){x._pending[B]=true});var z=v.extend({},y.changes,this._silent);this._silent={};q._objectEach(z,function(C,B){x.trigger("change:"+B,x,x.get(B),y)});if(A){return this}var w=function(C,B){if(!x._pending[B]&&!x._silent[B]){delete x.changed[B]}};while(!v.isEmpty(this._pending)){this._pending={};this.trigger("change",this,y);q._objectEach(this.changed,w);x._previousAttributes=v.clone(this.attributes)}this._changing=false;return this},existed:function(){return this._existed},hasChanged:function(w){if(!arguments.length){return !v.isEmpty(this.changed)}return this.changed&&v.has(this.changed,w)},changedAttributes:function(x){if(!x){return this.hasChanged()?v.clone(this.changed):false}var y={};var w=this._previousAttributes;q._objectEach(x,function(A,z){if(!v.isEqual(w[z],A)){y[z]=A}});return y},previous:function(w){if(!arguments.length||!this._previousAttributes){return null}return this._previousAttributes[w]},previousAttributes:function(){return v.clone(this._previousAttributes)},isValid:function(){return !this.validate(this.attributes)},validate:function(x,w){if(v.has(x,"ACL")&&!(x.ACL instanceof q.ACL)){return new q.Error(q.Error.OTHER_CAUSE,"ACL must be a Bmob.ACL.")}return false},_validate:function(y,x){if(x.silent||!this.validate){return true}y=v.extend({},this.attributes,y);var w=this.validate(y,x);if(!w){return true}if(x&&x.error){x.error(this,w,x)}else{this.trigger("error",this,w,x)}return false},getACL:function(){return this.get("ACL")},setACL:function(x,w){return this.set("ACL",x,w)}});q.Object.createWithoutData=function(y,z,x){var w=new q.Object(y);w.id=z;w._hasData=x;return w};q.Object.destroyAll=function(B,x){if(B==null||B.length==0){return q.Promise.as()._thenRunCallbacks(x)}var y=B[0].className;var C="";var w=true;B.forEach(function(D){if(D.className!=y){throw"Bmob.Object.destroyAll requires the argument object array's classNames must be the same"}if(!D.id){throw"Could not delete unsaved object"}if(w){C=D.id;w=false}else{C=C+","+D.id}});var A=v.map(B,function(D){var E=D._getSaveJSON();var G="POST";var F="/1/classes/"+D.className;if(D.id){F=F+"/"+D.id;G="DELETE"}D._startSave();return{method:G,path:F,}});var z=q._request("batch",null,null,"POST",{"requests":A});return z._thenRunCallbacks(x)};q.Object._getSubclass=function(x){if(!v.isString(x)){throw"Bmob.Object._getSubclass requires a string argument."}var w=q.Object._classMap[x];if(!w){w=q.Object.extend(x);q.Object._classMap[x]=w}return w};q.Object._create=function(z,w,x){var y=q.Object._getSubclass(z);return new y(w,x)};q.Object._classMap={};q.Object._extend=q._extend;q.Object.extend=function(z,y,A){if(!v.isString(z)){if(z&&v.has(z,"className")){return q.Object.extend(z.className,z,y)}else{throw new Error("Bmob.Object.extend's first argument should be the className.")}}if(z==="User"){z="_User"}var w=null;if(v.has(q.Object._classMap,z)){var x=q.Object._classMap[z];w=x._extend(y,A)}else{y=y||{};y.className=z;w=this._extend(y,A)}w.extend=function(C){if(v.isString(C)||(C&&v.has(C,"className"))){return q.Object.extend.apply(w,arguments)}var B=[z].concat(q._.toArray(arguments));return q.Object.extend.apply(w,B)};q.Object._classMap[z]=w;return w};q.Object._findUnsavedChildren=function(w,x,y){q._traverse(w,function(z){if(z instanceof q.Object){z._refreshCache();if(z.dirty()){x.push(z)}return}if(z instanceof q.File){if(!z.url()){y.push(z)}return}})};q.Object._canBeSerializedAsValue=function(w){var x=true;if(w instanceof q.Object){x=!!w.id}else{if(v.isArray(w)){q._arrayEach(w,function(y){if(!q.Object._canBeSerializedAsValue(y)){x=false}})}else{if(v.isObject(w)){q._objectEach(w,function(y){if(!q.Object._canBeSerializedAsValue(y)){x=false
}})}}}return x};q.Object._deepSaveAsync=function(x){var w=[];var A=[];q.Object._findUnsavedChildren(x,w,A);var B=q.Promise.as();v.each(A,function(C){B=B.then(function(){return C.save()})});var z=v.uniq(w);var y=v.uniq(z);return B.then(function(){return q.Promise._continueWhile(function(){return y.length>0},function(){var F=[];var C=[];q._arrayEach(y,function(G){if(F.length>20){C.push(G);return}if(G._canBeSerialized()){F.push(G)}else{C.push(G)}});y=C;if(F.length===0){return q.Promise.error(new q.Error(q.Error.OTHER_CAUSE,"Tried to save a batch with a cycle."))}var D=q.Promise.when(v.map(F,function(G){return G._allPreviousSaves||q.Promise.as()}));var E=new q.Promise();q._arrayEach(F,function(G){G._allPreviousSaves=E});return D._continueWith(function(){return q._request("batch",null,null,"POST",{requests:v.map(F,function(G){var H=G._getSaveJSON();var J="POST";var I="/1/classes/"+G.className;if(G.id){I=I+"/"+G.id;J="PUT"}G._startSave();return{method:J,path:I,body:H}})}).then(function(H,G,J){var I;q._arrayEach(F,function(K,L){if(H[L].success){K._finishSave(K.parse(H[L].success,G,J))}else{I=I||H[L].error;K._cancelSave()}});if(I){return q.Promise.error(new q.Error(I.code,I.error))}}).then(function(G){E.resolve(G);return G},function(G){E.reject(G);return q.Promise.error(G)})})})}).then(function(){return x})};q.Role=q.Object.extend("_Role",{constructor:function(w,x){if(v.isString(w)&&(x instanceof q.ACL)){q.Object.prototype.constructor.call(this,null,null);this.setName(w);this.setACL(x)}else{q.Object.prototype.constructor.call(this,w,x)}},getName:function(){return this.get("name")},setName:function(x,w){return this.set("name",x,w)},getUsers:function(){return this.relation("users")},getRoles:function(){return this.relation("roles")},validate:function(y,x){if("name" in y&&y.name!==this.getName()){var w=y.name;if(this.id&&this.id!==y.objectId){return new q.Error(q.Error.OTHER_CAUSE,"A role's name can only be set before it has been saved.")}if(!v.isString(w)){return new q.Error(q.Error.OTHER_CAUSE,"A role's name must be a String.")}if(!(/^[0-9a-zA-Z\-_ ]+$/).test(w)){return new q.Error(q.Error.OTHER_CAUSE,"A role's name can only contain alphanumeric characters, _,"+" -, and spaces.")}}if(q.Object.prototype.validate){return q.Object.prototype.validate.call(this,y,x)}return false}});q.Collection=function(x,w){w=w||{};if(w.comparator){this.comparator=w.comparator}if(w.model){this.model=w.model}if(w.query){this.query=w.query}this._reset();this.initialize.apply(this,arguments);if(x){this.reset(x,{silent:true,parse:w.parse})}};v.extend(q.Collection.prototype,q.Events,{model:q.Object,initialize:function(){},toJSON:function(){return this.map(function(w){return w.toJSON()})},add:function(x,F){var B,D,z,C,E,y,A={},w={};F=F||{};x=v.isArray(x)?x.slice():[x];for(B=0,z=x.length;B<z;B++){x[B]=this._prepareModel(x[B],F);C=x[B];if(!C){throw new Error("Can't add an invalid model to a collection")}E=C.cid;if(A[E]||this._byCid[E]){throw new Error("Duplicate cid: can't add the same model "+"to a collection twice")}y=C.id;if(!q._isNullOrUndefined(y)&&(w[y]||this._byId[y])){throw new Error("Duplicate id: can't add the same model "+"to a collection twice")}w[y]=C;A[E]=C}for(B=0;B<z;B++){(C=x[B]).on("all",this._onModelEvent,this);this._byCid[C.cid]=C;if(C.id){this._byId[C.id]=C}}this.length+=z;D=q._isNullOrUndefined(F.at)?this.models.length:F.at;this.models.splice.apply(this.models,[D,0].concat(x));if(this.comparator){this.sort({silent:true})}if(F.silent){return this}for(B=0,z=this.models.length;B<z;B++){C=this.models[B];if(A[C.cid]){F.index=B;C.trigger("add",C,this,F)}}return this},remove:function(B,z){var A,w,y,x;z=z||{};B=v.isArray(B)?B.slice():[B];for(A=0,w=B.length;A<w;A++){x=this.getByCid(B[A])||this.get(B[A]);if(!x){continue}delete this._byId[x.id];delete this._byCid[x.cid];y=this.indexOf(x);this.models.splice(y,1);this.length--;if(!z.silent){z.index=y;x.trigger("remove",x,this,z)}this._removeReference(x)}return this},get:function(w){return w&&this._byId[w.id||w]},getByCid:function(w){return w&&this._byCid[w.cid||w]},at:function(w){return this.models[w]},sort:function(x){x=x||{};if(!this.comparator){throw new Error("Cannot sort a set without a comparator")}var w=v.bind(this.comparator,this);if(this.comparator.length===1){this.models=this.sortBy(w)}else{this.models.sort(w)}if(!x.silent){this.trigger("reset",this,x)}return this},pluck:function(w){return v.map(this.models,function(x){return x.get(w)})},reset:function(y,x){var w=this;y=y||[];x=x||{};q._arrayEach(this.models,function(z){w._removeReference(z)});this._reset();this.add(y,{silent:true,parse:x.parse});if(!x.silent){this.trigger("reset",this,x)}return this},fetch:function(w){w=v.clone(w)||{};if(w.parse===undefined){w.parse=true}var y=this;var x=this.query||new q.Query(this.model);return x.find().then(function(z){if(w.add){y.add(z,w)}else{y.reset(z,w)}return y})._thenRunCallbacks(w,this)},create:function(x,w){var y=this;w=w?v.clone(w):{};x=this._prepareModel(x,w);if(!x){return false}if(!w.wait){y.add(x,w)
}var z=w.success;w.success=function(A,C,B){if(w.wait){y.add(A,w)}if(z){z(A,C)}else{A.trigger("sync",x,C,w)}};x.save(null,w);return x},parse:function(x,w){return x},chain:function(){return v(this.models).chain()},_reset:function(w){this.length=0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(y,x){if(!(y instanceof q.Object)){var w=y;x.collection=this;y=new this.model(w,x);if(!y._validate(y.attributes,x)){y=false}}else{if(!y.collection){y.collection=this}}return y},_removeReference:function(w){if(this===w.collection){delete w.collection}w.off("all",this._onModelEvent,this)},_onModelEvent:function(y,x,z,w){if((y==="add"||y==="remove")&&z!==this){return}if(y==="destroy"){this.remove(x,w)}if(x&&y==="change:objectId"){delete this._byId[x.previous("objectId")];this._byId[x.id]=x}this.trigger.apply(this,arguments)}});var r=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];q._arrayEach(r,function(w){q.Collection.prototype[w]=function(){return v[w].apply(v,[this.models].concat(v.toArray(arguments)))}});q.Collection.extend=q._extend;q.View=function(w){this.cid=v.uniqueId("view");this._configure(w||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var a=/^(\S+)\s*(.*)$/;var o=["model","collection","el","id","attributes","className","tagName"];v.extend(q.View.prototype,q.Events,{tagName:"div",$:function(w){return this.$el.find(w)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();return this},make:function(x,w,z){var y=document.createElement(x);if(w){q.$(y).attr(w)}if(z){q.$(y).html(z)}return y},setElement:function(w,x){this.$el=q.$(w);this.el=this.$el[0];if(x!==false){this.delegateEvents()}return this},delegateEvents:function(x){x=x||q._getValue(this,"events");if(!x){return}this.undelegateEvents();var w=this;q._objectEach(x,function(C,B){if(!v.isFunction(C)){C=w[x[B]]}if(!C){throw new Error('Event "'+x[B]+'" does not exist')}var A=B.match(a);var z=A[1],y=A[2];C=v.bind(C,w);z+=".delegateEvents"+w.cid;if(y===""){w.$el.bind(z,C)}else{w.$el.delegate(y,z,C)}})},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(x){if(this.options){x=v.extend({},this.options,x)}var w=this;v.each(o,function(y){if(x[y]){w[y]=x[y]}});this.options=x},_ensureElement:function(){if(!this.el){var w=q._getValue(this,"attributes")||{};if(this.id){w.id=this.id}if(this.className){w["class"]=this.className}this.setElement(this.make(this.tagName,w),false)}else{this.setElement(this.el,false)}}});q.View.extend=q._extend;q.User=q.Object.extend("_User",{_isCurrentUser:false,_mergeMagicFields:function(w){if(w.sessionToken){this._sessionToken=w.sessionToken;delete w.sessionToken}q.User.__super__._mergeMagicFields.call(this,w)},_cleanupAuthData:function(){if(!this.isCurrent()){return}var w=this.get("authData");if(!w){return}q._objectEach(this.get("authData"),function(y,x){if(!w[x]){delete w[x]}})},_synchronizeAllAuthData:function(){var x=this.get("authData");if(!x){return}var w=this;q._objectEach(this.get("authData"),function(z,y){w._synchronizeAuthData(y)})},_synchronizeAuthData:function(z){if(!this.isCurrent()){return}var w;if(v.isString(z)){w=z;z=q.User._authProviders[w]}else{w=z.getAuthType()}var x=this.get("authData");if(!x||!z){return}var y=z.restoreAuthentication(x[w]);if(!y){this._unlinkFrom(z)}},_handleSaveResult:function(w){if(w){this._isCurrentUser=true}this._cleanupAuthData();this._synchronizeAllAuthData();delete this._serverData.password;this._rebuildEstimatedDataForKey("password");this._refreshCache();if(w||this.isCurrent()){q.User._saveCurrentUser(this)}},_linkWith:function m(B,y){var C=this;var w;if(v.isString(B)){w=B;B=q.User._authProviders[B]}else{w=B.getAuthType()}if(y){var x=this.get("authData")||{};x[w]=y;this.set("authData",x);var A=new q.Promise();this.save({"authData":x},z).then(function(D){D._handleSaveResult(true);A.resolve(D)});return A._thenRunCallbacks({});var z=v.clone(y)||{};z.success=function(D){D._handleSaveResult(true);if(y.success){y.success.apply(this,arguments)}};return this.save({"authData":x},z)}else{return B.authenticate().then(function(D){return C._linkWith(B,D)})}},loginWithWeapp:function(x){var w=this;var y=new q.Promise();q.User.requestOpenId(x,{success:function(B){var z="weapp";var A=q.Object._create("_User");A._linkWith(z,B).then(function(C){y.resolve(C)},function(C){y.reject(C)})},error:function(z){y.reject(z)}});return y._thenRunCallbacks({})},_unlinkFrom:function(A,y){var x;if(v.isString(A)){x=A;A=q.User._authProviders[A]}else{x=A.getAuthType()}var z=v.clone(y);var w=this;z.authData=null;z.success=function(B){w._synchronizeAuthData(A);if(y.success){y.success.apply(this,arguments)}};return this._linkWith(A,z)},_isLinked:function(y){var w;
if(v.isString(y)){w=y}else{w=y.getAuthType()}var x=this.get("authData")||{};return !!x[w]},_logOutWithAll:function(){var x=this.get("authData");if(!x){return}var w=this;q._objectEach(this.get("authData"),function(z,y){w._logOutWith(y)})},_logOutWith:function(w){if(!this.isCurrent()){return}if(v.isString(w)){w=q.User._authProviders[w]}if(w&&w.deauthenticate){w.deauthenticate()}},signUp:function(z,y){var x;y=y||{};var B=(z&&z.username)||this.get("username");if(!B||(B==="")){x=new q.Error(q.Error.OTHER_CAUSE,"Cannot sign up user with an empty name.");if(y&&y.error){y.error(this,x)}return q.Promise.error(x)}var w=(z&&z.password)||this.get("password");if(!w||(w==="")){x=new q.Error(q.Error.OTHER_CAUSE,"Cannot sign up user with an empty password.");if(y&&y.error){y.error(this,x)}return q.Promise.error(x)}var A=v.clone(y);A.success=function(C){C._handleSaveResult(true);if(y.success){y.success.apply(this,arguments)}};return this.save(z,A)},logIn:function(x){var w=this;var y=q._request("login",null,null,"GET",this.toJSON());return y.then(function(C,z,B){var A=w.parse(C,z,B);w._finishFetch(A);w._handleSaveResult(true);return w})._thenRunCallbacks(x,this)},save:function(A,z,y){var x,D,B,E,C;if(v.isObject(A)||v.isNull(A)||v.isUndefined(A)){D=A;E=z}else{D={};D[A]=z;E=y}E=E||{};var w=v.clone(E);w.success=function(F){F._handleSaveResult(false);if(E.success){E.success.apply(this,arguments)}};return q.Object.prototype.save.call(this,D,w)},fetch:function(w){var x=w?v.clone(w):{};x.success=function(y){y._handleSaveResult(false);if(w&&w.success){w.success.apply(this,arguments)}};return q.Object.prototype.fetch.call(this,x)},isCurrent:function(){return this._isCurrentUser},getUsername:function(){return this.get("username")},setUsername:function(x,w){return this.set("username",x,w)},setPassword:function(x,w){return this.set("password",x,w)},getEmail:function(){return this.get("email")},setEmail:function(x,w){return this.set("email",x,w)},authenticated:function(){return !!this._sessionToken&&(q.User.current()&&q.User.current().id===this.id)}},{_currentUser:null,_currentUserMatchesDisk:false,_CURRENT_USER_KEY:"currentUser",_authProviders:{},signUp:function(A,z,y,x){y=y||{};y.username=A;y.password=z;var w=q.Object._create("_User");return w.signUp(y,x)},logIn:function(z,y,x){var w=q.Object._create("_User");w._finishFetch({username:z,password:y});return w.logIn(x)},logOut:function(){if(q.User._currentUser!==null){q.User._currentUser._logOutWithAll();q.User._currentUser._isCurrentUser=false}q.User._currentUserMatchesDisk=true;q.User._currentUser=null;wx.removeStorage({key:q._getBmobPath(q.User._CURRENT_USER_KEY),success:function(w){console.log(w.data)}})},requestPasswordReset:function(x,w){var y={email:x};var z=q._request("requestPasswordReset",null,null,"POST",y);return z._thenRunCallbacks(w)},requestEmailVerify:function(x,w){var y={email:x};var z=q._request("requestEmailVerify",null,null,"POST",y);return z._thenRunCallbacks(w)},requestOpenId:function(z,w){var x={code:z};var y=q._request("wechatApp",z,null,"POST",x);return y._thenRunCallbacks(w)},current:function(){if(q.User._currentUser){return q.User._currentUser}if(q.User._currentUserMatchesDisk){return q.User._currentUser}q.User._currentUserMatchesDisk=true;var w=false;try{var w=wx.getStorageSync(q._getBmobPath(q.User._CURRENT_USER_KEY));if(w){q.User._currentUser=q.Object._create("_User");q.User._currentUser._isCurrentUser=true;var x=JSON.parse(w);q.User._currentUser.id=x._id;delete x._id;q.User._currentUser._sessionToken=x._sessionToken;delete x._sessionToken;q.User._currentUser.set(x);q.User._currentUser._synchronizeAllAuthData();q.User._currentUser._refreshCache();q.User._currentUser._opSetQueue=[{}];return q.User._currentUser}}catch(y){return null}},_saveCurrentUser:function(w){if(q.User._currentUser!==w){q.User.logOut()}w._isCurrentUser=true;q.User._currentUser=w;q.User._currentUserMatchesDisk=true;var x=w.toJSON();x._id=w.id;x._sessionToken=w._sessionToken;wx.setStorage({key:q._getBmobPath(q.User._CURRENT_USER_KEY),data:JSON.stringify(x)})},_registerAuthenticationProvider:function(w){q.User._authProviders[w.getAuthType()]=w;if(q.User.current()){q.User.current()._synchronizeAuthData(w.getAuthType())}},_logInWith:function(y,x){var w=q.Object._create("_User");return w._linkWith(y,x)}});q.Query=function(w){if(v.isString(w)){w=q.Object._getSubclass(w)}this.objectClass=w;this.className=w.prototype.className;this._where={};this._include=[];this._limit=-1;this._skip=0;this._extraOptions={}};q.Query.or=function(){var w=v.toArray(arguments);var x=null;q._arrayEach(w,function(z){if(v.isNull(x)){x=z.className}if(x!==z.className){throw"All queries must be for the same class"}});var y=new q.Query(x);y._orQuery(w);return y};q.Query._extend=q._extend;q.Query.prototype={_processResult:function(w){return w},get:function(w,y){var x=this;x.equalTo("objectId",w);return x.first().then(function(z){if(z){return z}var A=new q.Error(q.Error.OBJECT_NOT_FOUND,"Object not found.");return q.Promise.error(A)
})._thenRunCallbacks(y,null)},toJSON:function(){var w={where:this._where};if(this._include.length>0){w.include=this._include.join(",")}if(this._select){w.keys=this._select.join(",")}if(this._limit>=0){w.limit=this._limit}if(this._skip>0){w.skip=this._skip}if(this._order!==undefined){w.order=this._order}q._objectEach(this._extraOptions,function(y,x){w[x]=y});return w},_newObject:function(w){if(typeof(x)==="undefined"){var x}if(w&&w.className){x=new q.Object(w.className)}else{x=new this.objectClass()}return x},_createRequest:function(w){return q._request("classes",this.className,null,"GET",w||this.toJSON())},find:function(x){var w=this;var y=this._createRequest();return y.then(function(z){return v.map(z.results,function(A){var B=w._newObject(z);B._finishFetch(w._processResult(A),true);return B})})._thenRunCallbacks(x)},destroyAll:function(x){var w=this;return w.find().then(function(y){return q.Object.destroyAll(y)})._thenRunCallbacks(x)},count:function(w){var y=this.toJSON();y.limit=0;y.count=1;var x=this._createRequest(y);return x.then(function(z){return z.count})._thenRunCallbacks(w)},first:function(x){var w=this;var z=this.toJSON();z.limit=1;var y=this._createRequest(z);return y.then(function(A){return v.map(A.results,function(B){var C=w._newObject();C._finishFetch(w._processResult(B),true);return C})[0]})._thenRunCallbacks(x)},collection:function(w,x){x=x||{};return new q.Collection(w,v.extend(x,{model:this._objectClass||this.objectClass,query:this}))},skip:function(w){this._skip=w;return this},limit:function(w){this._limit=w;return this},equalTo:function(w,x){this._where[w]=q._encode(x);return this},_addCondition:function(w,y,x){if(!this._where[w]){this._where[w]={}}this._where[w][y]=q._encode(x);return this},notEqualTo:function(w,x){this._addCondition(w,"$ne",x);return this},lessThan:function(w,x){this._addCondition(w,"$lt",x);return this},greaterThan:function(w,x){this._addCondition(w,"$gt",x);return this},lessThanOrEqualTo:function(w,x){this._addCondition(w,"$lte",x);return this},greaterThanOrEqualTo:function(w,x){this._addCondition(w,"$gte",x);return this},containedIn:function(x,w){this._addCondition(x,"$in",w);return this},notContainedIn:function(x,w){this._addCondition(x,"$nin",w);return this},containsAll:function(x,w){this._addCondition(x,"$all",w);return this},exists:function(w){this._addCondition(w,"$exists",true);return this},doesNotExist:function(w){this._addCondition(w,"$exists",false);return this},matches:function(x,y,w){this._addCondition(x,"$regex",y);if(!w){w=""}if(y.ignoreCase){w+="i"}if(y.multiline){w+="m"}if(w&&w.length){this._addCondition(x,"$options",w)}return this},matchesQuery:function(w,y){var x=y.toJSON();x.className=y.className;this._addCondition(w,"$inQuery",x);return this},doesNotMatchQuery:function(w,y){var x=y.toJSON();x.className=y.className;this._addCondition(w,"$notInQuery",x);return this},matchesKeyInQuery:function(x,w,z){var y=z.toJSON();y.className=z.className;this._addCondition(x,"$select",{key:w,query:y});return this},doesNotMatchKeyInQuery:function(x,w,z){var y=z.toJSON();y.className=z.className;this._addCondition(x,"$dontSelect",{key:w,query:y});return this},_orQuery:function(w){var x=v.map(w,function(y){return y.toJSON().where});this._where.$or=x;return this},_quote:function(w){return"\\Q"+w.replace("\\E","\\E\\\\E\\Q")+"\\E"},contains:function(w,x){this._addCondition(w,"$regex",this._quote(x));return this},startsWith:function(w,x){this._addCondition(w,"$regex","^"+this._quote(x));return this},endsWith:function(w,x){this._addCondition(w,"$regex",this._quote(x)+"$");return this},ascending:function(w){if(q._isNullOrUndefined(this._order)){this._order=w}else{this._order=this._order+","+w}return this},cleanOrder:function(w){this._order=null;return this},descending:function(w){if(q._isNullOrUndefined(this._order)){this._order="-"+w}else{this._order=this._order+",-"+w}return this},near:function(x,w){if(!(w instanceof q.GeoPoint)){w=new q.GeoPoint(w)}this._addCondition(x,"$nearSphere",w);return this},withinRadians:function(x,w,y){this.near(x,w);this._addCondition(x,"$maxDistance",y);return this},withinMiles:function(x,w,y){return this.withinRadians(x,w,y/3958.8)},withinKilometers:function(x,w,y){return this.withinRadians(x,w,y/6371)},withinGeoBox:function(w,y,x){if(!(y instanceof q.GeoPoint)){y=new q.GeoPoint(y)}if(!(x instanceof q.GeoPoint)){x=new q.GeoPoint(x)}this._addCondition(w,"$within",{"$box":[y,x]});return this},include:function(){var w=this;q._arrayEach(arguments,function(x){if(v.isArray(x)){w._include=w._include.concat(x)}else{w._include.push(x)}});return this},select:function(){var w=this;this._select=this._select||[];q._arrayEach(arguments,function(x){if(v.isArray(x)){w._select=w._select.concat(x)}else{w._select.push(x)}});return this},each:function(B,x){x=x||{};if(this._order||this._skip||(this._limit>=0)){var w="Cannot iterate on a query with sort, skip, or limit.";return q.Promise.error(w)._thenRunCallbacks(x)}var z=new q.Promise();var y=new q.Query(this.objectClass);
y._limit=x.batchSize||100;y._where=v.clone(this._where);y._include=v.clone(this._include);y.ascending("objectId");var A=false;return q.Promise._continueWhile(function(){return !A},function(){return y.find().then(function(C){var D=q.Promise.as();q._.each(C,function(E){D=D.then(function(){return B(E)})});return D.then(function(){if(C.length>=y._limit){y.greaterThan("objectId",C[C.length-1].id)}else{A=true}})})})._thenRunCallbacks(x)}};q.FriendShipQuery=q.Query._extend({_objectClass:q.User,_newObject:function(){return new q.User()},_processResult:function(x){var w=x[this._friendshipTag];if(w.__type==="Pointer"&&w.className==="_User"){delete w.__type;delete w.className}return w},});q.History=function(){this.handlers=[];v.bindAll(this,"checkUrl")};var l=/^[#\/]/;var h=/msie [\w.]+/;q.History.started=false;v.extend(q.History.prototype,q.Events,{interval:50,getHash:function(y){var x=y?y.location:window.location;var w=x.href.match(/#(.*)$/);return w?w[1]:""},getFragment:function(x,w){if(q._isNullOrUndefined(x)){if(this._hasPushState||w){x=window.location.pathname;var y=window.location.search;if(y){x+=y}}else{x=this.getHash()}}if(!x.indexOf(this.options.root)){x=x.substr(this.options.root.length)}return x.replace(l,"")},start:function(y){if(q.History.started){throw new Error("Bmob.history has already been started")}q.History.started=true;this.options=v.extend({},{root:"/"},this.options,y);this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var x=this.getFragment();var w=document.documentMode;var A=(h.exec(navigator.userAgent.toLowerCase())&&(!w||w<=7));if(A){this.iframe=q.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(x)}if(this._hasPushState){q.$(window).bind("popstate",this.checkUrl)}else{if(this._wantsHashChange&&("onhashchange" in window)&&!A){q.$(window).bind("hashchange",this.checkUrl)}else{if(this._wantsHashChange){this._checkUrlInterval=window.setInterval(this.checkUrl,this.interval)}}}this.fragment=x;var B=window.location;var z=B.pathname===this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!z){this.fragment=this.getFragment(null,true);window.location.replace(this.options.root+"#"+this.fragment);return true}else{if(this._wantsPushState&&this._hasPushState&&z&&B.hash){this.fragment=this.getHash().replace(l,"");window.history.replaceState({},document.title,B.protocol+"//"+B.host+this.options.root+this.fragment)}}if(!this.options.silent){return this.loadUrl()}},stop:function(){q.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);window.clearInterval(this._checkUrlInterval);q.History.started=false},route:function(w,x){this.handlers.unshift({route:w,callback:x})},checkUrl:function(x){var w=this.getFragment();if(w===this.fragment&&this.iframe){w=this.getFragment(this.getHash(this.iframe))}if(w===this.fragment){return false}if(this.iframe){this.navigate(w)}if(!this.loadUrl()){this.loadUrl(this.getHash())}},loadUrl:function(y){var x=this.fragment=this.getFragment(y);var w=v.any(this.handlers,function(z){if(z.route.test(x)){z.callback(x);return true}});return w},navigate:function(y,x){if(!q.History.started){return false}if(!x||x===true){x={trigger:x}}var z=(y||"").replace(l,"");if(this.fragment===z){return}if(this._hasPushState){if(z.indexOf(this.options.root)!==0){z=this.options.root+z}this.fragment=z;var w=x.replace?"replaceState":"pushState";window.history[w]({},document.title,z)}else{if(this._wantsHashChange){this.fragment=z;this._updateHash(window.location,z,x.replace);if(this.iframe&&(z!==this.getFragment(this.getHash(this.iframe)))){if(!x.replace){this.iframe.document.open().close()}this._updateHash(this.iframe.location,z,x.replace)}}else{window.location.assign(this.options.root+y)}}if(x.trigger){this.loadUrl(y)}},_updateHash:function(w,x,y){if(y){var z=w.toString().replace(/(javascript:|#).*$/,"");w.replace(z+"#"+x)}else{w.hash=x}}});q.Router=function(w){w=w||{};if(w.routes){this.routes=w.routes}this._bindRoutes();this.initialize.apply(this,arguments)};var g=/:\w+/g;var s=/\*\w+/g;var c=/[\-\[\]{}()+?.,\\\^\$\|#\s]/g;v.extend(q.Router.prototype,q.Events,{initialize:function(){},route:function(w,x,y){q.history=q.history||new q.History();if(!v.isRegExp(w)){w=this._routeToRegExp(w)}if(!y){y=this[x]}q.history.route(w,v.bind(function(A){var z=this._extractParameters(w,A);if(y){y.apply(this,z)}this.trigger.apply(this,["route:"+x].concat(z));q.history.trigger("route",this,x,z)},this));return this},navigate:function(x,w){q.history.navigate(x,w)},_bindRoutes:function(){if(!this.routes){return}var x=[];for(var y in this.routes){if(this.routes.hasOwnProperty(y)){x.unshift([y,this.routes[y]])}}for(var z=0,w=x.length;z<w;z++){this.route(x[z][0],x[z][1],this[x[z][1]])}},_routeToRegExp:function(w){w=w.replace(c,"\\$&").replace(g,"([^/]+)").replace(s,"(.*?)");return new RegExp("^"+w+"$")
},_extractParameters:function(w,x){return w.exec(x).slice(1)}});q.Router.extend=q._extend;q.generateCode=q.generateCode||{};q.generateCode=function(y,w){var x=q._request("wechatApp/qr/generatecode",null,null,"POST",q._encode(y,null,true));return x.then(function(z){return q._decode(null,z)})._thenRunCallbacks(w)};q.sendMessage=q.sendMessage||{};q.sendMessage=function(y,w){var x=q._request("wechatApp/SendWeAppMessage",null,null,"POST",q._encode(y,null,true));return x.then(function(z){return q._decode(null,z)})._thenRunCallbacks(w)};q.sendMasterMessage=q.sendMasterMessage||{};q.sendMasterMessage=function(y,w){var x=q._request("wechatApp/notifyMsg",null,null,"POST",q._encode(y,null,true));return x.then(function(z){return q._decode(null,z)})._thenRunCallbacks(w)};q.Sms=q.Sms||{};v.extend(q.Sms,{requestSms:function(y,w){var x=q._request("requestSms",null,null,"POST",q._encode(y,null,true));return x.then(function(z){return q._decode(null,z)})._thenRunCallbacks(w)},requestSmsCode:function(y,w){var x=q._request("requestSmsCode",null,null,"POST",q._encode(y,null,true));return x.then(function(z){return q._decode(null,z)})._thenRunCallbacks(w)},verifySmsCode:function(y,A,w){var z={"mobilePhoneNumber":y};var x=q._request("verifySmsCode/"+A,null,null,"POST",q._encode(z,null,true));return x.then(function(B){return q._decode(null,B)})._thenRunCallbacks(w)},querySms:function(x,w){var y=q._request("querySms/"+x,null,null,"GET",null);return y.then(function(z){return q._decode(null,z)})._thenRunCallbacks(w)}});q.Pay=q.Pay||{};v.extend(q.Pay,{wechatPay:function(A,C,w,z,x){var B={"order_price":A,"product_name":C,"body":w,"open_id":z,"pay_type":4};var y=q._request("pay",null,null,"POST",q._encode(B,null,true));return y.then(function(D){return q._decode(null,D)})._thenRunCallbacks(x)},queryOrder:function(w,x){var y=q._request("pay/"+w,null,null,"GET",null);return y.then(function(z){return q._decode(null,z)})._thenRunCallbacks(x)}});q.Cloud=q.Cloud||{};v.extend(q.Cloud,{run:function(x,z,w){var y=q._request("functions",x,null,"POST",q._encode(z,null,true));return y.then(function(A){return q._decode(null,A).result})._thenRunCallbacks(w)}});q.Installation=q.Object.extend("_Installation");q.Push=q.Push||{};q.Push.send=function(y,w){if(y.where){y.where=y.where.toJSON().where}if(y.push_time){y.push_time=y.push_time.toJSON()}if(y.expiration_time){y.expiration_time=y.expiration_time.toJSON()}if(y.expiration_time&&y.expiration_time_interval){throw"Both expiration_time and expiration_time_interval can't be set"}var x=q._request("push",null,null,"POST",y);return x._thenRunCallbacks(w)};var f=("undefined"===typeof module?{}:module.exports);var b={};exports.BmobSocketIo=b}.call(this));